# ----------------------------------------------------------------------------
# Publish image in Docker Hub Workflow
# This workflow builds and pushes a Docker image to Docker Hub whenever
# a new release is published on GitHub or when code is merged into main.
# ----------------------------------------------------------------------------

name: Publish image in Docker Hub

on:
  # Se dispara cuando hay push a main (por ejemplo, tras un merge)
  push:
    branches:
      - main

  # Se dispara también cuando se publica un release
  release:
    types: [published]

jobs:
  build-and-push:
    runs-on: ubuntu-24.04

    steps:
      # 1. Check out del repositorio
      - name: Check out the repo
        uses: actions/checkout@v5

      # 2. Calcular IMAGE, TAG y PUSH según el tipo de evento
      - name: Set image metadata
        id: meta
        run: |
          IMAGE=${{ secrets.DOCKER_USER }}/uvlhub

          if [ "${{ github.event_name }}" = "release" ]; then
            # Si es un release, usamos el tag del release y hacemos push
            TAG=${{ github.event.release.tag_name }}
            PUSH=true
          else
            # Si es un push a main, usamos el SHA corto del commit
            TAG=${GITHUB_SHA::7}
            PUSH=true
          fi

          echo "IMAGE=$IMAGE" >> $GITHUB_OUTPUT
          echo "TAG=$TAG" >> $GITHUB_OUTPUT
          echo "PUSH=$PUSH" >> $GITHUB_OUTPUT

      # 3. Login en Docker Hub (siempre que vayamos a hacer push)
      - name: Log in to Docker Hub
        if: steps.meta.outputs.PUSH == 'true'
        uses: docker/login-action@v3.6.0
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 4. Build de la imagen
      - name: Build Docker image
        env:
          IMAGE: ${{ steps.meta.outputs.IMAGE }}
          TAG: ${{ steps.meta.outputs.TAG }}
        run: |
          echo "Building image: $IMAGE:$TAG"
          docker build \
            --build-arg VERSION_TAG=$TAG \
            -t $IMAGE:$TAG \
            -f docker/images/Dockerfile.prod .

      # 5. Push de la imagen
      - name: Push Docker image
        if: steps.meta.outputs.PUSH == 'true'
        env:
          IMAGE: ${{ steps.meta.outputs.IMAGE }}
          TAG: ${{ steps.meta.outputs.TAG }}
        run: |
          echo "Pushing image: $IMAGE:$TAG"
          docker push $IMAGE:$TAG

      # 6. Tag y push de latest (opcional, aquí lo hacemos siempre que haya push)
      - name: Tag and push latest
        if: steps.meta.outputs.PUSH == 'true'
        env:
          IMAGE: ${{ steps.meta.outputs.IMAGE }}
          TAG: ${{ steps.meta.outputs.TAG }}
        run: |
          echo "Tagging $IMAGE:$TAG as $IMAGE:latest"
          docker tag $IMAGE:$TAG $IMAGE:latest
          docker push $IMAGE:latest
